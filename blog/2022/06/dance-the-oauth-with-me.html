<!DOCTYPE html>
<html lang="en">
<head>
<title>Dance the OAuth with me - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - Dance the OAuth with me" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2022/06/dance-the-oauth-with-me.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - Dance the OAuth with me" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2002,2022 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="Dance the OAuth with me - OAuth and its cousin OIDC are the ubiquitous methods to gain identity and authorization information. Since it is a ménage à trois between a user, an Identity provider (IdP) and an application, refered to as &#39;Service provider&#39;, it is hard to trouble shoot. A play in five acts In the recent Project KE" />
<meta name="Keywords"
	content="WebDevelopment," />
<meta name="Abstract"
	content="Dance the OAuth with me - OAuth and its cousin OIDC are the ubiquitous methods to gain identity and authorization information. Since it is a ménage à trois between a user, an Identity provider (IdP) and an application, refered to as &#39;Service provider&#39;, it is hard to trouble shoot. A play in five acts In the recent Project KE" />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/prism.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/admonition.css" />
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body class="line-numbers">
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

     
    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2022/">2022</a> <span class="divider">/</span></li>
  <li><a href="/blog/2022/06/">June</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/webdevelopment.html">WebDevelopment</a>
  </li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2022/05/yes-no-maybe-booleans.html"><i class="icon-hand-left"></i>Yes No Maybe Boolean deserialization with Jackson</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2022/06/case-insensitive-deserialization.html">Case insensitive deserialization<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>Dance the OAuth with me</small></h1>
					<hr />
					<div><p><a href="https://www.oauth.com">OAuth</a> and its cousin <a href="https://openid.net">OIDC</a> are the ubiquitous methods to <a href="https://openid.net/gainpoc/">gain</a> identity and authorization information. Since it is a <a href="https://www.lexico.com/en/definition/menage_a_trois">ménage à trois</a> between a user, an <a href="https://en.wikipedia.org/wiki/Identity_provider">Identity provider (IdP)</a> and an application, refered to as "Service provider", it is hard to trouble shoot.</p>
<h2>A play in five acts</h2>
<p>In the recent <a href="https://opensource.hcltechsw.com/domino-keep-docs/">Project KEEP</a> we build an IdP into the API, so you have the choice of just using Domino or using an external IdP.</p>
<p>To ensure it works as expected several dependent HTTPS calls were needed. Each call would harvest some information into environment variables for the following step</p>
<h3>Act 0 - initial setup</h3>
<p>Store several variables into the environment:</p>
<ul>
 <li><code>UserName</code>: the user you will simulate to approve</li>
 <li><code>Password</code>: their password</li>
 <li><code>HOST</code>: The starting URL for the first call</li>
 <li><code>state</code>: a random string, need to stay the same through the sequence</li>
 <li><code>client_id</code>: The application configured as service provider</li>
 <li><code>client_secret</code>: The service provider "password"</li>
 <li><code>scope</code>: the scope (or a subset) you have configured for the service provider</li>
 <li><code>redirect_uri</code>: one of the redirection URIs you have configured for the service provider</li>
</ul>
<p>An OAuth flow contains basic authentication calls, so you need to ensure proper <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a> connections.</p>
<p><img src="/blog/images/2022/OAuthDance.svg" alt="OAuth Dance"></p><h3>Act 1 - lay of the land</h3>
<p>Establish the end-points you have to deal with:</p>
<pre><code class="language-bash">curl --location --request GET "$HOST/.well-known/openid-configuration"
</code></pre>
<p>Harvest from the JSON response (<a href="https://stedolan.github.io/jq/">JQ</a> is your friend):</p>
<ul>
 <li><code>authorization_endpoint</code>: URL for the service provider to request authorization</li>
 <li><code>token_endpoint</code>: URL where authorization can be exchanged for access tokens</li>
</ul>
<h3>Act 2 - ask nicely</h3>
<p>This call initiates the flow and ends with a <code>302</code> status code, sending you to the UI part for granting or revoking access</p>
<pre><code class="language-bash">curl --location -g --request GET "$authorization_endpoint?client_id=$client_id&amp;response_type=code&amp;state=$state&amp;scope=$scope&amp;redirect_uri=$redirect_uri"
</code></pre>
<p>There won't be a body result, but a <code>Location</code> header, you can grab and use in a <code>GET</code> request to retrieve the consent UI. This part in IdP specific, so using a different IdP will change act 3.</p>
<h3>Act 3 - authenticate and consent</h3>
<p>Two calls are required. First authenticate with KEEP, then consent for the application to have access:</p>
<pre><code class="language-bash">curl --location --request POST "$HOST/api/v1/authforoauthflow" \
--header "Content-Type: application/json" \
--data-raw "{'password' : \"$Password\",'username' : \"$UserName\",'scopes' : 'oauth'}"
</code></pre>
<p>Harvest the <code>bearer</code> response from the JSON body. The publish you consent. This one is a classic HTML form post, so the header needs to be <code>application/x-www-form-urlencoded</code></p>
<pre><code class="language-bash">curl --location -g --request POST '{{authorization_endpoint}}/decision' \
--header "Authorization: Bearer $bearer" \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'response_type=code' \
--data-urlencode "scope=$scope" \
--data-urlencode "state=$state" \
--data-urlencode "client_id=$client_id" \
--data-urlencode "redirect_uri=$redirect_uri" \
--data-urlencode 'decision=allow'
</code></pre>
<p>The JSON result will have only two values: <code>state</code> and <code>authorization_code</code>. Capture the <code>authorization_code</code>.</p>
<h3>Act 4 - gain access</h3>
<p>The <code>authorization_code</code> has a short livespan, so it needs to get exchanged for an access token and a refresh token. This call works <strong>once</strong>. A second call will fail without Act 3 being repeated. This call again is a classic HTML form post.</p>
<pre><code class="language-bash">curl --location -g --request POST "$token_endpoint" \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=authorization_code' \
--data-urlencode "code=$authorization_code" \
--data-urlencode "redirect_uri=$redirect_uri" \
--data-urlencode "client_id=$client_id" \
--data-urlencode "client_secret=$client_secret"
</code></pre>
<p><strong>Note</strong> In bash environment variables only get resolved in double quotes, hence the mixed use of single and double quotes here.</p>
<p>The JSON result will contain the <code>access_token</code>, which is your KEEP compliant, short lived JWT and the <code>refresh_token</code> to get a new access token without the need for user interaction. To verify that it is working call this:</p>
<pre><code class="language-bash">curl --location -g --request POST "$token_endpoint}}" \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode "refresh_token=$app_refresh_token" \
--data-urlencode "scope=$scope" \
--data-urlencode "client_id=$client_id" \
--data-urlencode "client_secret=$client_secret"
</code></pre>
<p>Again the <code>access_token</code> is your KEEP JWT. The call will not issue a new refresh token.</p>
<h3><a href="https://www.merriam-webster.com/dictionary/epilogue">Epilogue</a></h3>
<p>In just five acts, you can manually retrace the steps the OAuth dance performs to gain access. There's a variation to it: instead of <code>client_id</code> and <code>client_secret</code> being posted in the request body, they can be supplied as basic authentication header:</p>
<pre><code class="language-bash">curl -p "$client_id:$client_secret" ...
</code></pre>
<p>As usual YMMV</p></div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 06 June 2022
<span class="divider">|</span>
<a href="/blog/2022/06/dance-the-oauth-with-me.html#comments">Comments (1)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/webdevelopment.html">WebDevelopment</a> 

						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2022/06/dance-the-oauth-with-me.html";
						</script>
					</p>
				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_d4acca20-e579-11ec-b9b8-f1cad397bc73" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_d4acca20-e579-11ec-b9b8-f1cad397bc73"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li>
							posted by <b>Jorgen</b> on <i>Monday 20 June 2022 AD</i>:<br /> <p>When will HCL Domino Keep be released?</p>

							<hr style="clear : both" />
						</li> 					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2022/05/yes-no-maybe-booleans.html"><i class="icon-hand-left"></i>Yes No Maybe Boolean deserialization with Jackson</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2022/06/case-insensitive-deserialization.html">Case insensitive deserialization<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2022/">2022</a> <span class="divider">/</span></li>
  <li><a href="/blog/2022/06/">June</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/webdevelopment.html">WebDevelopment</a>
  </li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I work as "Solution Director Innovation" for HCL Software. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a rel="me" href="https://chaos.social/@stw">Chat on Mastodon</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://notessensei.myspreadshop.com">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="https://www.stickermule.com/u/43c09fe6343315f">Stickers from Stickermule</a></li>
						<li><a href="https://github.com/Stwissel">GitHub</a></li>
						<li><a href="https://bitbucket.org/stwissel/">Bitbucket</a></li>
						<li><a href="https://bsky.app/profile/stwissel.bsky.social">Bluesky</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2025 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2022/06/dance-the-oauth-with-me.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/prism.js"></script>
	<script type="text/javascript" src="/blog/js2/admonition.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "d4acca20-e579-11ec-b9b8-f1cad397bc73");
 		};
	</script>

</body>
</html>
