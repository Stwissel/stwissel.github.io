<!DOCTYPE html>
<html lang="en">
<head>
<title>Annotations to supercharge your vert.x development - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - Annotations to supercharge your vert.x development" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2016/04/annotations-to-supercharge-your-vertx-development.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - Annotations to supercharge your vert.x development" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2002,2022 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="Annotations to supercharge your vert.x development - ProjectCastle is well under way. Part of it, the part talking to Domino, is written in Java8 and vert.x. With some prior experience in node.js development vert.x will look familiar: base on event loop and callbacks, you develop in a very similar way. The big differences: vert.x runs on the JVM8, it " />
<meta name="Keywords"
	content="vert.x," />
<meta name="Abstract"
	content="Annotations to supercharge your vert.x development - ProjectCastle is well under way. Part of it, the part talking to Domino, is written in Java8 and vert.x. With some prior experience in node.js development vert.x will look familiar: base on event loop and callbacks, you develop in a very similar way. The big differences: vert.x runs on the JVM8, it " />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/prism.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body class="line-numbers">
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

     
    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2016/">2016</a> <span class="divider">/</span></li>
  <li><a href="/blog/2016/04/">April</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/vertx.html">vert.x</a>
  </li>
	<li class="pull-right">
	<span class="divider">|</span><a href="/blog/d6plinks/SHWL-A8M22R" title="originally published at /blog/d6plinks/SHWL-A8M22R">SHWL-A8M22R</a>
	</li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2016/02/now-we-are-token-authorization-using-json-web-token-in-domino.html"><i class="icon-hand-left"></i>Now we are token - Authorization using JSON Web Token in Domino</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2016/05/mach-dich-auf-die-socken.html">Mach Dich auf die Socken!<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>Annotations to supercharge your vert.x development</small></h1>
					<hr />
					<div>ProjectCastle is well under way. Part of it, the part talking to Domino, is written in Java8 and <a href="http://vertx.io">vert.x</a>. With some prior experience in node.js development vert.x will look familiar: base on event loop and callbacks, you develop in a very similar way. The big differences: vert.x runs on the JVM8, it is by nature of the JVM multi-threaded, features an event bus and is polyglot - you can develop in a mix of languages: Java, JavaScript, Jython, Groovy etc. 
<br>
 This post reflects some of the approaches I found useful developing with vert.x in Java. There are 3 components which are core to vert.x development: 
<ul>
 <li>
  <h4>Verticle</h4> A unit of compute running with an event loop. Usually you start one Verticle (optional with multiple instances) as your application, but you might want/need to start additional ones for longer running tasks. A special version is the worker verticle, that runs from a thread pool to allow execution of blocking operations</li>
 <li>
  <h4>EventBus</h4> The different components of your application message each other via the EventBus. Data send over the EventBus can be a String, a JsonObject or a buffer. You also can send any arbitrary Java class as message once you have defined a codec for it</li>
 <li>
  <h4>Route</h4> Like in node.js a vert.x web application can register routes and their handlers to react on web input under various conditions. Routes can be defined using URLs, HTTP Verbs, Content-Types ( for POST/PUT/PATCH operations)</li>
</ul> Ideally when defining a route and a handler, a verticle or a potential message for the EventBus, all necessary code stays contained in the respective source code file. The challenge here is to register the components when the application starts. Your main Verticle doesn't know what components are in your application and manually maintain a loader code is a pain to keep in sync (besides leading to merge conflicts when working in a team). 
<br>
 Java annotations to the rescue! If you are new to annotations, go and check out <a href="">this tutorial</a> to get up to speed. For my project I defined three of them, with one being able to be applied multiple times. 
<h3>CastleRequest</h3> A class annotated with CastleRequest registers its handler with the EventBus, so the class can be sent over the EventBus and get encoded/decode appropriately. A special value for the annotation is "self" which indicates, that the class itself implements the <a href="http://vertx.io/docs/apidocs/io/vertx/core/eventbus/MessageCodec.html">MessageCodec</a> interface 
<br>
<pre><code class="language-java">
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface CastleRequest {
  // We use value to ease the syntax
  // to @CastleRequest(NameOfCodec)
  // Special value: self = class implements the MessageCodec interface
  String value();
}
</code></pre>
<h3>CastleRoute</h3> This annotation can be assigned multiple times, so 2 annotation interfaces are needed 
<br>
<pre><code class="language-java">
@Documented
@Repeatable(CastleRoutes.class)
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface CastleRoute {
  String route();
  String description();
  String mimetype() default "any";
  String method() default "any";
}
</code></pre>
<br>
 and the repeatability annotation (new with Java8): 
<br>
<pre><code class="language-java">
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface CastleRoutes {
  CastleRoute[] value();
}
</code></pre>
<h3>CastleVerticle</h3> Classes marked with this annotation are loaded as verticles. They can implement listeners to the whole spectrum of vert.x listening capabilities 
<br>
<pre><code class="language-java">
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface CastleVerticle {
  String type() default "worker";
  int instances() default 0;
  boolean multithreaded() default false;
}
</code></pre><h3>Loading it all</h3> With a little glue code (see below), all Verticles, Routes and Codecs get loaded by looking up the annotations. You add a new file or remove one: no additional action is required. 
<br>
 Since traversing all classes is expensive, we have one method that does that once calling the 3 different annotation processors once for each class 
<br>
<pre><code class="language-java">
private void loadClassesByAnnotation(final Router router) {
    try {
      // Get the classes from the current loader to check for more
      final ClassPath classPath = ClassPath.from(this.getClass().getClassLoader());
      // Extract the package name from the full class name
      String packageName = this.getClass().getName();
      packageName = packageName.substring(0, packageName.lastIndexOf("."));
      // Get all classes in this tree
      for (final ClassInfo classInfo : classPath.getTopLevelClassesRecursive(packageName)) {
        @SuppressWarnings("rawtypes")
        final Class candidate = classInfo.load();
        this.loadVerticleByAnnotation(candidate);
        this.loadCodecByAnnotation(candidate);
        this.loadRouteByAnnotation(candidate);
      }
    } catch (IOException e) {
      this.logger.error(e);
    }
 }

@SuppressWarnings({ "rawtypes", "unchecked" })
private void loadCodecByAnnotation(final Class candidate) {
EventBus eventBus = this.vertx.eventBus();
final Annotation[] annotation = candidate.getAnnotationsByType(CastleRequest.class);
// Registering all Codecs
for (int i = 0; i &lt; annotation.length; i++) {
try {
final CastleRequest cr = (CastleRequest) annotation[i];
final String codecClassName = cr.value();
Object codecCandidate;
if (codecClassName.equalsIgnoreCase("self")) {
// The object contains its own message codec
codecCandidate = candidate.newInstance();
} else {
codecCandidate = Class.forName(codecClassName).newInstance();
}
if (codecCandidate instanceof MessageCodec) {
MessageCodec messageCodec = (MessageCodec) codecCandidate;
eventBus.registerDefaultCodec(candidate, messageCodec);
} else {
this.logger.error("Class with CastleRequest Annotation has wrong codec type:" + codecClassName);
}
} catch (InstantiationException | IllegalAccessException | ClassNotFoundException e) {
this.logger.error(e);
}
}
}

@SuppressWarnings({ "unchecked", "rawtypes" })
private void loadRouteByAnnotation(final Class candidate) {
final Annotation[] annotation = candidate.getAnnotationsByType(CastleRoute.class);
for (int i = 0; i &lt; annotation.length; i++) {
try {
final CastleRoute cr = (CastleRoute) annotation[i];
// We got a class that shall be used as a router
if (CastleRouteHandler.class.isAssignableFrom(candidate)) {
// If a class has multiple routes assigned we might load them more
// than once but that's acceptable
final Class

 <castleroutehandler>
  
   toBeloaded = candidate;
          CastleRouteHandler crh = toBeloaded.newInstance();
          // Finally initialization and recording in our list
          crh.init(this.vertx, router, cr.method(), cr.route(), cr.mimetype(), cr.description());
          this.routeList.put(cr.route(), cr.description());
          this.routeHandlers.add(crh);
        } else {
          this.logger.error("Class with CastleRouter Annotation has wrong type:" + candidate.getName());
        }
      } catch (InstantiationException | IllegalAccessException e) {
        this.logger.error(e);
      }
    }
  }

@SuppressWarnings({ "rawtypes", "unchecked" })
private void loadVerticleByAnnotation(final Class candidate) {
final Annotation[] annotation = candidate.getAnnotationsByType(CastleVerticle.class);
for (int i = 0; i &lt; annotation.length; i++) {
if (Verticle.class.isAssignableFrom(candidate)) {
final CastleVerticle cv = (CastleVerticle) annotation[i];
final String verticleID = candidate.getName();
final DeploymentOptions options = new DeploymentOptions();
if (cv.type().equalsIgnoreCase("worker")) {
options.setWorker(true);
}
// Overwrite the instances if number is specified
if (cv.instances() &gt; 0) {
options.setInstances(cv.instances());
}
options.setMultiThreaded(cv.multithreaded());
this.vertx.deployVerticle(verticleID, options, result -&gt; {
if (result.succeeded()) {
this.logger.info(verticleID + " started as " + result.result());
this.localVerticles.add(result.result());
} else {
this.logger.error(result.cause());
}
});
} else {
this.logger.error("Class with CastleVerticle Annotation has wrong type:" + candidate.getName());
}
}
}

public interface CastleRouteHandler {
public String getDescription();
// Return the actual route
public String getRoute();
// The methods that needs to be overwritten in each instance
// One for each method we do support
public void handleDelete(final RoutingContext ctx);
public void handleGet(final RoutingContext ctx);
public void handleHead(final RoutingContext ctx);
public void handleOptions(final RoutingContext ctx);
public void handlePost(final RoutingContext ctx);
public void handlePut(final RoutingContext ctx);
public void handlePatch(final RoutingContext ctx);
// initialize the actual route
public AbstractCastleRouteHandler init(final Vertx vertx, final Router router, final String method, final String route, String mimetype, String description);
}

public AbstractCastleRouteHandler init(final Vertx vertx, final Router router, final String method, final String route,
final String mimetype, final String description) {
this.vertx = vertx;
this.description = description;
this.route = route;
this.logger.info("Loading " + this.getClass().getName() + " for " + this.getRoute() + " .. " + description);
Route localRoute = null;
if ("any".equalsIgnoreCase(method) || "GET".equalsIgnoreCase(method)) {
localRoute = router.get(route).handler(this::handleGet);
}
if ("any".equalsIgnoreCase(method) || "POST".equalsIgnoreCase(method)) {
localRoute = router.post(route).handler(this::handlePost);
}
if ("any".equalsIgnoreCase(method) || "PUT".equalsIgnoreCase(method)) {
localRoute = router.put(route).handler(this::handlePut);
}
if ("any".equalsIgnoreCase(method) || "PATCH".equalsIgnoreCase(method)) {
localRoute = router.put(route).handler(this::handlePatch);
}
if ("any".equalsIgnoreCase(method) || "DELETE".equalsIgnoreCase(method)) {
localRoute = router.delete(route).handler(this::handleDelete);
}

    if (localRoute != null &amp;&amp; !"any".equalsIgnoreCase(mimetype)) {
      localRoute.consumes(mimetype);
    }

    // Methods that need to be always available
    router.options(route).handler(this::handleOptions);
    router.options(route).handler(this::handleHead);

    return this;

}

</castleroutehandler></code></pre>
<br>
 Left as an exercise to the reader: runs the analysis at compile time instead of runtime. 
<br>
As usual: YMMV</div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 02 April 2016
<span class="divider">|</span>
<a href="/blog/2016/04/annotations-to-supercharge-your-vertx-development.html#comments">Comments (0)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/vertx.html">vert.x</a> 

						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2016/04/annotations-to-supercharge-your-vertx-development.html";
						</script>
					</p>
				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_30DE462FC074A36C48257F89000019CB" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_30DE462FC074A36C48257F89000019CB"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li id="nocomments">
							<h5>No comments yet, be the first to comment</h5>
						</li>
					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2016/02/now-we-are-token-authorization-using-json-web-token-in-domino.html"><i class="icon-hand-left"></i>Now we are token - Authorization using JSON Web Token in Domino</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2016/05/mach-dich-auf-die-socken.html">Mach Dich auf die Socken!<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2016/">2016</a> <span class="divider">/</span></li>
  <li><a href="/blog/2016/04/">April</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/vertx.html">vert.x</a>
  </li>
	<li class="pull-right">
	<span class="divider">|</span><a href="/blog/d6plinks/SHWL-A8M22R" title="originally published at /blog/d6plinks/SHWL-A8M22R">SHWL-A8M22R</a>
	</li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I work as "Solution Director Innovation" for HCL Software. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a rel="me" href="https://chaos.social/@stw">Chat on Mastodon</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://notessensei.myspreadshop.com">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="https://www.stickermule.com/u/43c09fe6343315f">Stickers from Stickermule</a></li>
						<li><a href="https://about.me/stephan.wissel/#" title="Another identity site, nothing much here">About Me</a></li>
						<li><a href="https://github.com/Stwissel">GitHub</a></li>
						<li><a href="https://bitbucket.org/stwissel/">Bitbucket</a></li>
						<li><a href="https://www.twitter.com/notessensei">Twitter</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2023 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2016/04/annotations-to-supercharge-your-vertx-development.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/prism.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "30DE462FC074A36C48257F89000019CB");
 		};
	</script>

</body>
</html>
