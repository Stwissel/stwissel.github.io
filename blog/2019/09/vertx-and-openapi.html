<!DOCTYPE html>
<html lang="en">
<head>
<title>Vert.x and OpenAPI - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - Vert.x and OpenAPI" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2019/09/vertx-and-openapi.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - Vert.x and OpenAPI" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2002,2022 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="Vert.x and OpenAPI - In the shiny new world of the API Economy your API definition and its enforcement is everything. The current standard for REST based APIs is OpenAPI. What it gives you is a JSON or YAML file that describes how your API looks like. There is a whole zoo of tools around that allow to visualize, edit, r" />
<meta name="Keywords"
	content="Java,vert.x,WebDevelopment," />
<meta name="Abstract"
	content="Vert.x and OpenAPI - In the shiny new world of the API Economy your API definition and its enforcement is everything. The current standard for REST based APIs is OpenAPI. What it gives you is a JSON or YAML file that describes how your API looks like. There is a whole zoo of tools around that allow to visualize, edit, r" />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/prism.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body class="line-numbers">
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

     
    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2019/">2019</a> <span class="divider">/</span></li>
  <li><a href="/blog/2019/09/">September</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/java.html">Java</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/vertx.html">vert.x</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/webdevelopment.html">WebDevelopment</a>
  </li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2019/06/adding-a-proxy-to-your-salesforce-communities.html"><i class="icon-hand-left"></i>Adding a proxy to your Salesforce Communities</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2019/10/the-caldav-standard.html">The calDAV Standard - navigating the RFC jungle<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>Vert.x and OpenAPI</small></h1>
					<hr />
					<div><p>In the shiny new world of the <a href="https://www.gartner.com/smarterwithgartner/welcome-to-the-api-economy/">API Economy</a> your API definition and its enforcement is everything. The current <a href="https://xkcd.com/927/">standard</a> for REST based APIs is <a href="https://www.openapis.org/">OpenAPI</a>. What it gives you is a JSON or YAML file that describes how your API looks like. There is a whole zoo of tools around that allow to visualize, edit, run Mock servers or generate client and server code.</p>
<p>My favorite editor for OpenAPI specs is <a href="https://www.apicur.io/">Apicurio</a>, a project driven by <a href="https://www.redhat.com">RedHat</a>. It strikes a nice balance between being UI driven and leaving you access to the full source code of your specification.</p>
<h3>What to do with it</h3>
<p>Your API specification defines:</p>
<ul>
 <li>the endpoints (a.k.a the URLS that you can use)</li>
 <li>the mime types that can be sent or will received</li>
 <li>the parameters in the path (the URL)</li>
 <li>the parameters in the query (the part that looks like <code>?color=red&amp;shape=circle</code>)</li>
 <li>the body to send and receive</li>
 <li>the authentication / authorization requirements</li>
 <li>the potential <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">status codes</a> (we love 2xx)</li>
</ul>
<p>To handle all this, it smells like boilerplate or, if you are lucky, ready library. <a href="http://vertx.io/">vert.x</a> has the later. It provides the <a href="https://vertx.io/docs/vertx-web-api-contract/java/">API Contract</a> module that is designed to handle all this for you. You simply add the module to your <code>pom.xml</code> and load your json or yaml OpenApi specification file:</p>
<pre><code class="language-xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-web-api-contract&lt;/artifactId&gt;
 &lt;version&gt;3.8.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>The <a href="https://vertx.io/docs/vertx-web-api-contract/java/#_openapi_3">documentation</a> shows the code to turn the OpenApi speccification into a Router factory:</p>
<pre><code class="language-java">OpenAPI3RouterFactory.create(
  vertx,
  "https://raw.githubusercontent.com/OAI/OpenAPI-Specification/master/examples/v3.0/petstore.yaml",
  ar -&gt; {
    if (ar.succeeded()) {
      // Spec loaded with success
      OpenAPI3RouterFactory routerFactory = ar.result();
    } else {
      // Something went wrong during router factory initialization
      Throwable exception = ar.cause();
    }
  });
</code></pre>
<p>As you can see, you can load the spec from an URL (there's an auth option too). So while your API is evolving using <a href="https://www.apicur.io/">Apicurio</a> you can live load the latest and greated from the live preview (should make some interesting breakages ;-) ).</p>
<p>You then add your routes using <code>routerFactory.addHandlerByOperationId("awesomeOperation",this::awesomeOperationHandler)</code>. Vert.x doesn't use the path to match the handler, but the operationId. This allows you to update path information without breaking your code. There is a detailed <a href="https://how-to.vertx.io/web-and-openapi-howto/">how-to document</a> describing the steps.</p>
<h3>Generate a skeleton for vert.x</h3>
<p>As long as you haven't specified a handler for an operation, Vert.x will automatically reply with <code>501 Not implemented</code> and not throw any error. To give you a headstart, you can generate the base code. First option is to head to <a href="https://start.vertx.io/">start.vertx.io</a> to generate a standard project skeleton, saving you the manual work of creating all dependencies in your <code>pom.xml</code> file. Using "<em>Show dependency panel</em>" provides a convenient way to pick the modules you need.</p>
<p>But there are better ways. You can use an <a href="https://openapi-generator.tech/">OpenAPI Generator</a> or the advanced <a href="https://vertx-starter.jetdrone.xyz/#maven">Vert.x Starter</a> courtesy of <a href="https://www.linkedin.com/in/pmlopes/">Paulo Lopes</a>. In his tool you specify what it shall generate in a dropdown that defaults to "<em>Empty Project</em>". Once you change that to "<em>OpenAPI Server</em>" the form will alloow you to upload your OpenAPI specification and you get a complete project rendered with all handler stubs including the security handler. There's also a <a href="https://vertx-starter.jetdrone.xyz/#npm">JavaScript</a> version available.</p><h3>Auto-load route handlers</h3>
<p>Having a skeleton for starters makes it easy to understand the moving parts. However when your API is still rapidly evolving you constantly need to edit your verticle containing the <a href="https://vertx.io/docs/apidocs/io/vertx/ext/web/api/contract/openapi3/OpenAPI3RouterFactory.html">RouterFactory</a> to add new handlers using <a href="https://vertx.io/docs/apidocs/io/vertx/ext/web/api/contract/openapi3/OpenAPI3RouterFactory.html#addHandlerByOperationId-java.lang.String-io.vertx.core.Handler-"><code>addHandlerByOperationId</code></a>. So I thought: a little <a href="https://stackoverflow.com/questions/37628/what-is-reflection-and-why-is-it-useful">reflection</a> can go a long way.</p>
<p>What if the OperationId determines the class name of the handler to use? I used the following constraints:</p>
<ul>
 <li>All handlers are members of the same Java package</li>
 <li>All handlers use the same constructor. What worked for me: a constructor giving the handler access to vert.x and my configuration in form of a JSON object</li>
 <li>The name of the handler is <em>OperationId</em>Handler where, to conform with Java practises the first letter would be capitalized</li>
</ul>
<p>As a result a few lines of code will try to load handler classes for all routes presented in the OpenAPI specs.</p>
<h4>Starting the verticle</h4>
<pre><code class="language-java">@Override
    public void start(final Promise&lt;Void&gt; startFuture) {
        // String fileName =
        // this.getClass().getResource(Constants.OPENAPI_FILE_NAME).getFile();
        final String fileName = Constants.OPENAPI_FILE_NAME;
        OpenAPI3RouterFactory.create(this.getVertx(),
                fileName,
                ar -&gt; {
                    if (ar.succeeded()) {
                        final OpenAPI3RouterFactory routerFactory = ar.result();
                        this.mountHandlersAndListen(routerFactory, startFuture);
                    } else {
                        startFuture.fail(ar.cause());
                    }
                });
    }
</code></pre>
<h4>Getting all operationIds from the OpenAPI spec</h4>
<pre><code class="language-java">/**
     * Extracts the operationId from the openapi.json file to get a list of required
     * mount points
     *
     * @return list with operationIds
     */
    private List&lt;String&gt; getOperationIds() {
        final List&lt;String&gt; result = new ArrayList&lt;&gt;();
        // Gets the openapi.json file content readily parsed into JSON
        final JsonObject openApi = this.getOpenAPI();
        final JsonObject paths = openApi.getJsonObject("paths", new JsonObject());
        paths.forEach(path -&gt; {
            final JsonObject methods = (JsonObject) path.getValue();
            methods.forEach(method -&gt; {
                final Object o = method.getValue();
                if (o instanceof JsonObject) {
                    final JsonObject methodContent = (JsonObject) o;
                    final String operationID = methodContent.getString("operationId");
                    if (operationID != null) {
                        result.add(operationID);
                    }
                }
            });
        });
        return result;
    }
</code></pre>
<h4>Mounting routes</h4>
<pre><code class="language-java">      private void mountHandlersAndListen(final OpenAPI3RouterFactory routerFactory, final Promise&lt;Void&gt; startFuture) {
        final RouterFactoryOptions rfo = new RouterFactoryOptions();
        rfo.setMountNotImplementedHandler(true).setRequireSecurityHandlers(true);

        final List&lt;String&gt; operationIds = this.getOperationIds();

        // Path handlers
        operationIds.forEach(id -&gt; this.loadHandlers(routerFactory, id));

        // Security handler basic
        routerFactory.addSecurityHandler("basic", new BasicHandler());

        // Security handler JWT
        // Simple handler, don't use in production
        final JWTAuth provider = JWTAuth.create(this.vertx, new JWTAuthOptions()
                .addPubSecKey(new PubSecKeyOptions()
                        .setAlgorithm("HS256")
                        .setPublicKey(this.config().getString(Constants.CONFIG_JWTSECRET, Constants.CONFIG_JWTSECRET))
                        .setSymmetric(true)));

        final AuthHandler authHandler = JWTAuthHandler.create(provider);
        authHandler.addAuthority("user");
        routerFactory.addSecurityHandler("jwt", authHandler);

        final int port = 8089;
        this.router = routerFactory.getRouter();
        this.server = this.vertx.createHttpServer(new HttpServerOptions().setPort(port));
        this.server.requestHandler(this.router).listen();
        startFuture.complete();
    }
</code></pre>
<h4>Load available handlers</h4>
<pre><code class="language-java">      private void loadHandlers(final OpenAPI3RouterFactory routerFactory, final String id) {
        final String className = "com.somepackage.handlers."
                + id.substring(0, 1).toUpperCase()
                + id.substring(1).toLowerCase()
                + "Handler";

        try {
            // All Handlers need a constructor that makes vertx and config available
            final Class handlerClass = Class.forName(className);
            final Class[] paramClasses = new Class[] { Vertx.class, JsonObject.class };
            final Constructor constructor = handlerClass.getConstructor(paramClasses);
            final Handler&lt;RoutingContext&gt; handler = (Handler) constructor.newInstance(this.getVertx(), this.config());
            routerFactory.addHandlerByOperationId(id, handler);
            this.logger.debug("Added operation id: " + id);

        } catch (final Exception e) {
            this.logger.warn("Could not load Handler:" + className);
        }
    }
</code></pre>
<h3>Conclusion</h3>
<p>Using this approach you don't need to touch your router Verticle. Once the OpenAPI spec is updated, the log will contain a warning about a missing class.<br> Implementing that class is the only action to get your new route operational.</p>
<p>As ususal YMMV!</p></div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 06 September 2019
<span class="divider">|</span>
<a href="/blog/2019/09/vertx-and-openapi.html#comments">Comments (0)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/java.html">Java</a>  <a href="/blog/categories/vertx.html">vert.x</a>  <a href="/blog/categories/webdevelopment.html">WebDevelopment</a> 

						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2019/09/vertx-and-openapi.html";
						</script>
					</p>
				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_86e88e10-d08b-11e9-ae24-cf34c96a740e" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_86e88e10-d08b-11e9-ae24-cf34c96a740e"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li id="nocomments">
							<h5>No comments yet, be the first to comment</h5>
						</li>
					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2019/06/adding-a-proxy-to-your-salesforce-communities.html"><i class="icon-hand-left"></i>Adding a proxy to your Salesforce Communities</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2019/10/the-caldav-standard.html">The calDAV Standard - navigating the RFC jungle<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2019/">2019</a> <span class="divider">/</span></li>
  <li><a href="/blog/2019/09/">September</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/java.html">Java</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/vertx.html">vert.x</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/webdevelopment.html">WebDevelopment</a>
  </li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I work as "Solution Director Innovation" for HCL Software. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a rel="me" href="https://chaos.social/@stw">Chat on Mastodon</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://notessensei.myspreadshop.com">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="https://www.stickermule.com/u/43c09fe6343315f">Stickers from Stickermule</a></li>
						<li><a href="https://about.me/stephan.wissel/#" title="Another identity site, nothing much here">About Me</a></li>
						<li><a href="https://github.com/Stwissel">GitHub</a></li>
						<li><a href="https://bitbucket.org/stwissel/">Bitbucket</a></li>
						<li><a href="https://www.twitter.com/notessensei">Twitter</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2023 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2019/09/vertx-and-openapi.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/prism.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "86e88e10-d08b-11e9-ae24-cf34c96a740e");
 		};
	</script>

</body>
</html>
