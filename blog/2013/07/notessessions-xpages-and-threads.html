<!DOCTYPE html>
<html lang="en">
<head>
<title>NotesSessions, XPages and Threads - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - NotesSessions, XPages and Threads" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2013/07/notessessions-xpages-and-threads.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - NotesSessions, XPages and Threads" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2002,2022 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="NotesSessions, XPages and Threads - When you build an XPages application, long running operations will time out. After all there is a timing limit how long a browser (or XPiNC) client (and the user) will wait for a response. You could resort to launching an agent via a console command, but besides the security consideration it is quit" />
<meta name="Keywords"
	content="XPages," />
<meta name="Abstract"
	content="NotesSessions, XPages and Threads - When you build an XPages application, long running operations will time out. After all there is a timing limit how long a browser (or XPiNC) client (and the user) will wait for a response. You could resort to launching an agent via a console command, but besides the security consideration it is quit" />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/prism.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body class="line-numbers">
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

     
    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2013/">2013</a> <span class="divider">/</span></li>
  <li><a href="/blog/2013/07/">July</a></li>
	<li class="pull-right">
	<a href="/blog/d6plinks/SHWL-99U64Q" title="originally published at /blog/d6plinks/SHWL-99U64Q">SHWL-99U64Q</a>
	</li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/xpages.html">XPages</a>
  </li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2013/07/xpinc-development-insights.html"><i class="icon-hand-left"></i>XPiNC development insights</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2013/07/protecting-your-xpages-application.html">Protecting your XPages Application<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>NotesSessions, XPages and Threads</small></h1>
					<hr />
					<div>When you build an XPages application, long running operations will time out. After all there is a timing limit how long a browser (or XPiNC) client (and the user) will wait for a response. You could resort to launching an agent via a console command, but besides the security consideration it is quite a hack and headache. Mixing XPages and agents doesn't have a happy ending (and should be confined to the upgrading phase of your classic application). 
<br> Enter <a href="http://www.vogella.com/articles/JavaConcurrency/article.html">Java multi-threading</a>. I call it " <i>Teenage-mode</i>": your code does multiple things at the same time and doesn't seem to get distracted. 
<br> When you read <a href="http://www.mindview.net/Books/TIJ/">the classics</a> you will find threading hard and rather threatening (pun intended), but thanks to progress in Java6 and above it isn't too hard. 
<br> There is the <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Executor.html">Executor</a> framework that handles all your <code>Runnables</code>. There are 2 challenges to overcome: one specific to Notes and one general to all concurrency programming. The former: The Notes <code>Session</code> class is not threadsave and can't be shared between threads, the later: you have to get your queueing right: 
<br><a href="http://chewonitcomics.blogspot.sg/2009/02/you-foreigner.html" title="Queuing is a challenge in Singapore"><img src="https://i485.photobucket.com/albums/rr219/chewonitcomics/myopic_mrt.jpg" border="0"></a>
<br> (Image courtesy of <a href="http://chewonitcomics.blogspot.sg/">Lee Chee Chew</a>) 
<br> To get a new <code>Session</code> object, we have the session cloner, thanks to the extension library. All your threads implement the <code>Runnable</code> interface that is later called by the executor framework. There are 2 approaches for background task: one where you expect the thread to return some value at some time and the other where a thread runs its course and terminates silently when done. For a <a href="/blog/2013/07/xpinc-development-insights.html">current project</a> I opted for the later. The threads contain a callback class where they report back what they have to say. To make it all work we need: 
<ol>
 <li>A management class that executes the threads for us. Preferably long living (like session or application beans)</li>
 <li>A cloned Notes Session</li>
 <li>One or more classes implementing the runnable interface</li>
</ol> Let's look at some code, first the class that runs in the background: 
<div class="java5"><span class="kw2">package</span><span class="co2">com.notessensei.demo</span><span class="sy0">;</span>
 <br>
 <br><span class="kw2">import</span><span class="co2">java.util.Collection</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">java.util.Map</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">lotus.domino.Database</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">lotus.domino.NotesException</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">lotus.domino.Session</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">com.ibm.domino.xsp.module.nsf.NSFComponentModule</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">com.ibm.domino.xsp.module.nsf.NotesContext</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">com.ibm.domino.xsp.module.nsf.SessionCloner</span><span class="sy0">;</span>
 <br>
 <br><span class="kw2">public abstract class</span> AbstractNotesBackgroundTask <span class="kw2">implements</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Runnable.html"><span class="kw21">Runnable</span></a><span class="br0">{</span>
 <br> &nbsp; &nbsp; <span class="kw2">protected</span><span class="kw2">final</span> Session &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notesSession <span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="kw2">protected</span><span class="kw2">final</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/util/Collection.html"><span class="kw46">Collection</span></a><span class="sy0">&lt;</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/String.html"><span class="kw21">String</span></a><span class="sy0">&gt;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; callBackMessages <span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="kw2">private</span> SessionCloner &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sessionCloner <span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="kw2">private</span> NSFComponentModule&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; module <span class="sy0">;</span>
 <br> &nbsp; &nbsp; 
 <br> &nbsp; &nbsp; <span class="kw2">public</span> AbstractNotesBackgroundTask <span class="br0">(</span><span class="kw2">final</span> Session optionalSession, <span class="kw2">final</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/util/Collection.html"><span class="kw46">Collection</span></a><span class="sy0">&lt;</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/String.html"><span class="kw21">String</span></a><span class="sy0">&gt;</span> messageHandler <span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">callBackMessages</span> = messageHandler <span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// optionalSession MUST be NULL when this should run in a thread, contain a session when</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// the class is running in the same thread as it was constructed</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">notesSession</span> = optionalSession <span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">setDominoContextCloner</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br>
 <br> &nbsp; &nbsp; <span class="kw2">public</span><span class="kw3">void</span> run <span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">callBackMessages</span>. <span class="me1">add</span><span class="br0">(</span><span class="st0">"Background task run starting: "</span> + <span class="kw2">this</span>. <span class="me1">getClass</span><span class="br0">(</span><span class="br0">)</span>. <span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">try</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Session session <span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">(</span><span class="kw2">this</span>. <span class="me1">notesSession</span> == <span class="kw4">null</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NotesContext context = <span class="kw2">new</span> NotesContext <span class="br0">(</span><span class="kw2">this</span>. <span class="me1">module</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NotesContext. <span class="me1">initThread</span><span class="br0">(</span>context <span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session = <span class="kw2">this</span>. <span class="me1">sessionCloner</span>. <span class="me1">getSession</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span><span class="kw1">else</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// We run in an established session</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session = <span class="kw2">this</span>. <span class="me1">notesSession</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/* Do the work here */</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">runNotes</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span><span class="kw2">catch</span><span class="br0">(</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Throwable.html"><span class="kw21">Throwable</span></a> e <span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e. <span class="me1">printStacktrace</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span><span class="kw2">finally</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">(</span><span class="kw2">this</span>. <span class="me1">notesSession</span> == <span class="kw4">null</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NotesContext. <span class="me1">termThread</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">try</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">sessionCloner</span>. <span class="me1">recycle</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span><span class="kw2">catch</span><span class="br0">(</span>NotesException e1 <span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e1. <span class="me1">printStacktrace</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">callBackMessages</span>. <span class="me1">add</span><span class="br0">(</span><span class="st0">"Background task run completed: "</span> + <span class="kw2">this</span>. <span class="me1">getClass</span><span class="br0">(</span><span class="br0">)</span>. <span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br>
 <br> &nbsp; &nbsp; <span class="kw2">private</span><span class="kw3">void</span> setDominoContextCloner <span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Domino stuff to be able to get a cloned session</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">(</span><span class="kw2">this</span>. <span class="me1">notesSession</span> == <span class="kw4">null</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">try</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">module</span> = NotesContext. <span class="me1">getCurrent</span><span class="br0">(</span><span class="br0">)</span>. <span class="me1">getModule</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">sessionCloner</span> = SessionCloner. <span class="me1">getSessionCloner</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span><span class="kw2">catch</span><span class="br0">(</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Exception.html"><span class="kw21">Exception</span></a> e <span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e. <span class="me1">printStacktrace</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; 
 <br> &nbsp; &nbsp; <span class="kw2">protected</span><span class="kw2">abstract</span><span class="kw3">void</span> runNotes <span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br><span class="br0">}</span>
</div> You only need to subclass it and implement <code>runNotes()</code> to get started. However you probably want to hand over more parameters, so you need to modify the constructor accordingly. Please note: you can't bring Notes objects across thread boundaries. Next the class that controls all the threads. It should live in the session or application.The class is actually quite simple: 
<div class="java5"><span class="kw2">package</span><span class="co2">com.notessensei.demo</span><span class="sy0">;</span>
 <br>
 <br><span class="kw2">import</span><span class="co2">java.io.Serializable</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">java.util.concurrent.ExecutorService</span><span class="sy0">;</span>
 <br><span class="kw2">import</span><span class="co2">java.util.concurrent.Executors</span><span class="sy0">;</span>
 <br>
 <br><span class="kw2">public</span><span class="kw2">class</span> NotesBackgroundManager <span class="kw2">implements</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/io/Serializable.html"><span class="kw20">Serializable</span></a><span class="br0">{</span>
 <br> &nbsp; &nbsp; <span class="kw2">private</span><span class="kw2">static</span><span class="kw2">final</span><span class="kw3">long</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serialVersionUID&nbsp; &nbsp; &nbsp; &nbsp; = 1L <span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="co1">// # of threads running concurrently</span>
 <br> &nbsp; &nbsp; <span class="kw2">private</span><span class="kw2">static</span><span class="kw2">final</span><span class="kw3">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THREADPOOLSIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = <span class="nu0">10</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="kw2">private</span><span class="kw2">final</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/util/concurrent/ExecutorService.html"><span class="kw47">ExecutorService</span></a> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; service &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = <a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/util/concurrent/Executors.html"><span class="kw47">Executors</span></a>. <span class="me1">newFixedThreadPool</span><span class="br0">(</span>THREADPOOLSIZE <span class="br0">)</span><span class="sy0">;</span>
 <br>
 <br> &nbsp; &nbsp; <span class="kw2">public</span> CSIApplication <span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// For use in managed beans</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br>
 <br> &nbsp; &nbsp; <span class="kw2">public</span><span class="kw3">void</span> submitService <span class="br0">(</span><span class="kw2">final</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Runnable.html"><span class="kw21">Runnable</span></a> taskDef <span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">(</span>taskDef == <span class="kw4">null</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/System.html"><span class="kw21">System</span></a>. <span class="me1">err</span>. <span class="me1">println</span><span class="br0">(</span><span class="st0">"submitService: NULL callable submitted to submitService"</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">return</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Execute runs without return</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">service</span>. <span class="me1">execute</span><span class="br0">(</span>taskDef <span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br>
 <br> &nbsp; &nbsp; @ <a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Override.html"><span class="kw21">Override</span></a>
 <br> &nbsp; &nbsp; <span class="kw2">protected</span><span class="kw3">void</span> finalize <span class="br0">(</span><span class="br0">)</span><span class="kw2">throws</span><a href="http://java.sun.com/j2se/1%2E5%2E0/docs/api/java/lang/Throwable.html"><span class="kw21">Throwable</span></a><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">(</span><span class="br0">(</span><span class="kw2">this</span>. <span class="me1">service</span><span class="sy0">!</span>= <span class="kw4">null</span><span class="br0">)</span><span class="sy0">&amp;&amp;</span><span class="sy0">!</span><span class="kw2">this</span>. <span class="me1">service</span>. <span class="me1">isTerminated</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="br0">{</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">this</span>. <span class="me1">service</span>. <span class="me1">shutdown</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">}</span>
 <br> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">super</span>. <span class="me1">finalize</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
 <br> &nbsp; &nbsp; <span class="br0">}</span>
 <br><span class="br0">}</span>
</div> If you rather want the thread returning something at the end of the run (which you must poll from the <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a>, you would call <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ExecutorService.html#submit(java.lang.Runnable)">ExecutorService.submit</a> and get back a <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Future.html ">Future</a> holding the future result, but that's another story for another time. 
<br> The final missing piece is to define <code>NotesBackgroundManager</code> as <a href="https://www.google.com/search?q=XPages+managed+beans">managed bean</a> e.g. <code>background</code> and you can launch a background task in SSJS: <code>background.submitService(new com.notessensei.demo.SampleNotesBackgroundTask());</code>
<br> As usual YMMV.</div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 23 July 2013
<span class="divider">|</span>
<a href="/blog/2013/07/notessessions-xpages-and-threads.html#comments">Comments (7)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/xpages.html">XPages</a> 

						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2013/07/notessessions-xpages-and-threads.html";
						</script>
					</p>
				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_4F2FF7AFE405DE0E48257BB0001324B6" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_4F2FF7AFE405DE0E48257BB0001324B6"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li>
							posted by <b>Nathan T. Freeman</b> on <i>Tuesday 23 July 2013 AD</i>:<br /> 
  Wonderful article. Concurrency is something that Domino developers really should learn more about. 
  <br /> 
  <br />&quot;...The Notes Session class is not threadsave(sic) and can't be shared between threads...&quot; 
  <br /> 
  <br />We're all friends here, so I'm going to be a little pedantic, because I used to think this too. 
  <br /> 
  <br />It's not that you can't share a Session (or a Database or a Collection or whatever) between threads; it's that Domino objects *must* be recycled on the same thread in which they were established. So if you have Thread 1, and you have a Session and a Database that you then give to Thread 2, which creates Views, DocumentCollections, Documents and Items from there, all those View, DCs, Docs and Items must be recycled on Thread 2, but the Database and the Session MUST NOT be recycled on Thread 2. They can only be recycled on Thread 1 and obviously only after Thread 2 finishes its work. (Technically you *can* recycle on a different thread, if you don't mind the side-effect of crashing your client or server.) 
  <br /> 
  <br />What deepens the challenge still further is the following: Let's say you have Thread 1 with a Session, and you create Threads 2 and 3 with the same Session. Thread 2 gets a handle on foo.nsf and begins some processing. Thread 3 is processing something else, but also needs a handle on foo.nsf a few milliseconds later. Now you have a problem -- 2 and 3, because they share a Session, actually get the same handle on foo.nsf. But you don't really have any way of knowing that. 
  <br /> 
  <br />Recycle in 3, and you crash. Recycle in 2, and if 3 is still working, it gets the dreaded &quot;Object has been removed or recycled&quot; error. 
  <br /> 
  <br />You can try to keep track of who got what objects first, and who else accessed them and whether they still need them. And then you can .join all your Threads so they don't release any concurrently accessed objects until everyone else is finished with them. But you have to do all this with a lot of synchronized Maps and it's a serious performance killer. At some point, you ask yourself: why am I bothering with multiple threads when I have to synchronize everything that's happening anyway? 
  <br /> 
  <br />Or at least, that's what I did when trying to solve the problem for the OpenNTF Domino API. Once I got a mostly workable solution done, I ran some benchmarks, found that it was about 8 times slower, and said &quot;this is dumb. Just don't share Sessions between threads.&quot;
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Stephan Wissel</b> on <i>Tuesday 12 November 2013 AD</i>:<br /> 
  To keep my simple mind from blowing up, I invented the simple rule: if you make them, you dispose them. So if a method defines a NotesObject that object must be removed in the same method. Works most of the time. 
  <img alt="Emoticon biggrin.gif" src="/blog/images/emoticons/biggrin.gif" border="0" /> stw
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Greg</b> on <i>Friday 29 November 2013 AD</i>:<br /> 
  Thanks a lot for this article, it is something that I sorely need! (I don't like making a user wait while the application goes off on its own little tangent (task). 
  <br /> 
  <br />I was playing around with this because I want to create multiple documents while dynamically calculating and fetching configuration documents from other databases etc. And I keep getting the following error in the server log: 
  <br /> 
  <br />29.11.2013 11:14:17 HTTP JVM: Exception in thread &quot;pool-4-thread-1&quot; 
  <br />29.11.2013 11:14:17 HTTP JVM: java.lang.IllegalStateException: NotesContext not initialized for the thread 
  <br />29.11.2013 11:14:17 HTTP JVM: at com.ibm.domino.xsp.module.nsf.NotesContext.getCurrent(NotesContext.java:123) 
  <br />29.11.2013 11:14:17 HTTP JVM: at com.ibm.domino.xsp.module.nsf.ModuleClassLoader$DynamicClassLoader.loadClass(ModuleClassLoader.java:383) 
  <br />29.11.2013 11:14:17 HTTP JVM: at java.lang.ClassLoader.loadClass(ClassLoader.java:638) 
  <br />29.11.2013 11:14:17 HTTP JVM: at de.holistic.utils.multithreading.AbstractBackgroundTask.run(AbstractBackgroundTask.java:29) 
  <br />29.11.2013 11:14:17 HTTP JVM: at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:906) 
  <br />29.11.2013 11:14:17 HTTP JVM: at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:929) 
  <br />29.11.2013 11:14:17 HTTP JVM: at java.lang.Thread.run(Thread.java:738) 
  <br /> 
  <br />(sorry if that is a bit difficult to work with) 
  <br /> 
  <br />I am using Domino 901, Notes 900, and the latest 900 ExtLibs. Do you have any idea why I might be getting the IllegalStateException / NotesContext not initialized for the thread message? I am guessing that my first step should be to get my versions consistent with each other and try again, but I wanted to ask for your input as well.
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Greg</b> on <i>Friday 29 November 2013 AD</i>:<br /> 
  to make it easier: [link= stackoverflow.com/questions/20285907/xpage-concurrency-notescontext-not-initialized] here is a stack overflow question [/link]
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Panu Haaramo</b> on <i>Monday 13 October 2014 AD</i>:<br /> 
  I'm getting the same exception as Greg, NotesContext.getCurrent() fails. 
  <br /> 
  <br />Any idea why the same code works for you but not for us? Thanks.
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Stephan H. Wissel</b> on <i>Monday 13 October 2014 AD</i>:<br /> 
  I haven't revisited the code for a rather long time. The smartest way is to move on and use the OpenNTF Domino API. Nathan did an outstanding job to make that even easier.
 
							<hr style="clear : both" />
						</li> 						<li>
							posted by <b>Panu Haaramo</b> on <i>Tuesday 14 October 2014 AD</i>:<br /> 
  Thanks, haven't tried that yet. Actually your code works. I was not getting module and SessionCloner in the constructor.
 
							<hr style="clear : both" />
						</li> 					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2013/07/xpinc-development-insights.html"><i class="icon-hand-left"></i>XPiNC development insights</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2013/07/protecting-your-xpages-application.html">Protecting your XPages Application<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2013/">2013</a> <span class="divider">/</span></li>
  <li><a href="/blog/2013/07/">July</a></li>
	<li class="pull-right">
	<a href="/blog/d6plinks/SHWL-99U64Q" title="originally published at /blog/d6plinks/SHWL-99U64Q">SHWL-99U64Q</a>
	</li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/xpages.html">XPages</a>
  </li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I work as "Solution Director Innovation" for HCL Software. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a href="https://www.twitter.com/notessensei">Twitter</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://www.xing.com/profile/StephanH_Wissel">XING</a></li>
						<li><a href="https://notessensei.myspreadshop.com">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="http://about.me/stephan.wissel/#" title="Another identity site, nothing much here">About Me</a></li>
						<li><a rel="me" href="https://chaos.social/@stw">Chat on Mastodon</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2022 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2013/07/notessessions-xpages-and-threads.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/prism.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "4F2FF7AFE405DE0E48257BB0001324B6");
 		};
	</script>

</body>
</html>
