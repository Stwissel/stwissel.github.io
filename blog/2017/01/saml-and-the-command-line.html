<!DOCTYPE html>
<html lang="en">
<head>
<title>SAML and the Command Line - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - SAML and the Command Line" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2017/01/saml-and-the-command-line.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - SAML and the Command Line" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2017,2019 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="SAML and the Command Line&#10;One of the best kept secrets of Connections Cloud S1 is the Traveler API. The API allows interactions that are missing from the Admin UI, like deleting a specific device or implementing an approval workflow. Unfortunately the API only offers authentication via SAML, OAuth or BasicAuth are missing. S" />
<meta name="Keywords"
	content="JavaScript,NodeJS," />
<meta name="Abstract"
	content="SAML and the Command Line&#10;One of the best kept secrets of Connections Cloud S1 is the Traveler API. The API allows interactions that are missing from the Admin UI, like deleting a specific device or implementing an approval workflow. Unfortunately the API only offers authentication via SAML, OAuth or BasicAuth are missing. S" />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shCore.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shThemeMidnight.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link href='//fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css' />
<link href='//fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css' />
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body>
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

    <script> 
var $buoop = {notify:{e:-0.01,f:-0.01,o:-0.01,s:-0.01,c:-0.01},insecure:true,unsupported:true,api:5}; 
function $buo_f(){ 
 var e = document.createElement("script"); 
 e.src = "//browser-update.org/update.min.js"; 
 document.body.appendChild(e);
};
try {document.addEventListener("DOMContentLoaded", $buo_f,false)}
catch(e){window.attachEvent("onload", $buo_f)}
</script>

    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2017/">2017</a> <span class="divider">/</span></li>
  <li><a href="/blog/2017/01/">January</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/javascript.html">JavaScript</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/nodejs.html">NodeJS</a>
  </li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2017/01/git-deploy-your-static-sites-part-1.html"><i class="icon-hand-left"></i>GIT deploy your static sites - Part 1</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2017/02/agile-outsourcing.html">Agile Outsourcing<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>SAML and the Command Line</small></h1>
					<hr />
					<div>One of the best kept secrets of Connections Cloud S1 is the 
<a href="https://www-10.lotus.com/ldd/dominowiki.nsf/dx/IBM_Notes_Traveler_Administration_API">Traveler API</a>. The API allows interactions that are missing from the Admin UI, like deleting a specific device or implementing an approval workflow. 
<br> Unfortunately the API only offers authentication via SAML, OAuth or BasicAuth are missing. So any application interacting with the API needs to do 
<a href="https://www.google.com.sg/search?q=SAML+Dance+Connections+Cloud">The SAML Dance</a>. That's annoying when you have an UI to use, and a formidable challenge when you have a command line application, like a cron Job running unsupervised at interval. 
<br> One lovely step in the process: the IBM IdP returns a HTML page with a hidden form containing the SAML assertion result to be posted back to the application provider. Quite interesting, when your application provider is a command line app. Let's get to work. 
<br> The script is written in 
<a href="https://nodejs.org">node.js</a> and uses 
<a href="https://www.npmjs.com/package/request">request</a> and 
<a href="https://www.npmjs.com/package/fast-html-parser">fast-html-parser</a> npm package. The first step is to load the login form (which comes with a first set of cookies) 
<br> 
<pre class="brush: js">
var requestOptionsTemplate = {
    headers: {
        'Origin': 'https://api.notes.ap.collabserv.com/api/traveler/',
        'User-Agent': 'ancy CommandLine Script',
        'Connection': 'keep-alive',
        'Cache-Control': 'max-age=0',
        'Upgrade-Insecure-Requests': 1
    },
    'method': 'GET'
};

function scLoginPart1() {
    console.log('Authenticating to SmartCloud ...');
    var requestOptions = Object.assign({}, requestOptionsTemplate);
    requestOptions.url = 'https://apps.na.collabserv.com/manage/account/dashboardHandler/input';
    request(requestOptions, scLoginPart2);
}
</pre> 
<br> The function calls the URL where the login form can be found. The result gets delivered to the function 
<code>scLoginPart2</code>. That function makes use of a global configuration variable 
<code>config</code> that was created through 
<code>const config = require("./config.json")</code> and contains all the credentials we need. Step2 submits the form and hands over to Step3. 
<br> 
<pre class="brush: js">
function scLoginPart2(err, httpResponse, body) {
    if (err) {
        return console.error(err);
    }
    // Capture cookies
    var outgoingCookies = captureCookies(httpResponse);
    var requestOptions = Object.assign({}, requestOptionsTemplate);
    requestOptions.headers.Cookie = outgoingCookies.join('; ');
    requestOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    requestOptions.method = 'POST';
    requestOptions.url = 'https://apps.ap.collabserv.com/pkmslogin.form';
    requestOptions.form = {
        'login-form-type': 'pwd',
        'error-code': '',
        'username': config.smartcloud.user,
        'password': config.smartcloud.password,
        'show_login': 'showLoginAgain'
    }
    request(requestOptions, scLoginPart3);
}

function captureCookies(response) {
    var incomingCookies = response.headers['set-cookie'];
    var outgoingCookies = [];
    if (incomingCookies) {
        incomingCookies.forEach(function(cookie) {
            outgoingCookies.push(cookie.split(';')[0]);
        });
    }
    // Array, allows for duplicate coolie names
    return outgoingCookies;
}
</pre> 
<br> Part 3 / 4 finally collect all the cookies we need, so to turn attention to getting the API token in step 5 
<br> 
<pre class="brush: js">
function scLoginPart3(err, httpResponse, body) {
    if (err) {
        console.error('Login failed miserably');
        return console.error(err);
    }
    // Login returns not 200 but 302
    // see https://developer.ibm.com/social/2015/06/23/slight-changes-to-the-form-based-login/
    if (httpResponse.statusCode !== 302) {
        return console.error('Wrong status code received: ' + httpResponse.statusCode);
    }

    var outgoingCookies = captureCookies(httpResponse);
    var redirect = httpResponse.headers.location;

    // This is the 3rd request we need to make to get finally all cookies for app.na
    var requestOptions = Object.assign({}, requestOptionsTemplate);
    requestOptions.headers.Cookie = outgoingCookies.join('; ');
    requestOptions.url = redirect;
    request(requestOptions, scLoginPart4);
}

function scLoginPart4(err, httpResponse, body) {
    if (err) {
        console.error('Login redirect failed miserably');
        return console.error(err);
    }
    var cookieHarvest = captureCookies(httpResponse);
    // Now we have some cookies in app, we need the SAML dance for api.notes
    scLoginPart5(cookieHarvest)
}
</pre> 
<br> In Part 5 we first request the URL with actual data (devices in our case), but get another SAML dance step, since we have 
<code>apps.na</code> vs 
<code>api.notes</code> in the URL<br> 
<pre class="brush: js">
function scLoginPart5(incomingCookies) {
    console.log("Executing SAML postback to SmartCloud");
    var requestOptions = Object.assign({}, requestOptionsTemplate);
    requestOptions.headers.Cookie = incomingCookies.join('; ');
    // Here is the first time wa actually request the data we want
    requestOptions.url = 'https://api.notes.ap.collabserv.com/api/traveler/devices';
    request(requestOptions, scLoginPart6);
}
</pre> 
<br> Part 6 is the interesting one. If not authenticated against the 
<code>api.notes</code> URL yet, the server will return an HTML form with a JavaScript action that posts that form, containing the SAML assertion to the api URL. Since we don't use a browser to handle that automatically, we need to grab the html, extract the form and post it ourselves 
<br> 
<pre class="brush: js">
function scLoginPart6(err, httpResponse, body) {
    if (err) {
        return console.error(err);
    }
    // Check the content for HTML
    var contentType = httpResponse.headers['content-type'];
    if (contentType.indexOf('html') &gt; 0) {
        var root = htmlparser.parse(body);
        var samlForm = root.querySelector('form');
        // We need action
        var samlAttr = samlForm.attributes;
        var action = samlAttr['action'];
        console.log('SmartCloud login action:' + action);
        // checking if the action is a full qualified URL
        if (action.substring(0, 4) != 'http') {
            // That would be an error condition
            console.error('Authentication to SmartCloud failed');
            process.exit(1);
        }
        var samlFields = samlForm.querySelectorAll('input');
        var postbackform = {};
        samlFields.forEach(function(field) {
            var attr = field.attributes;
            var fName = attr['name'];
            var fValue = attr['value'];
            postbackform[fName] = fValue;
        });

        var newOptions = Object.assign({}, requestOptionsTemplate);
        newOptions.method = 'POST';
        newOptions.form = postbackform;
        newOptions.url = action;
        newOptions.headers['Cookie'] = captureCookies(httpResponse).join('; ');
        request(newOptions, scLoginPart7);
    } else {
        console.error('Authentication to SmartCloud failed');
        process.exit(1);
    }
}
</pre> 
<br> Part 7 then processes an successful redirect to get our first actual payload. 
<br> 
<pre class="brush: js">
function scLoginPart7(err, response, body) {
    if (err) {
        return console.error(err);
    }
    var resultCookies = captureCookies(response);
    var location = response.headers['location'];
    var nextDance = Object.assign({}, requestOptionsTemplate);
    nextDance.headers['Cookie'] = resultCookies.join('; ');
    nextDance.url = location;
    nextDance.method = 'GET';
    delete nextDance.headers['Content-Type'];

    request(nextDance, function(err, danceResponse, goodBody) {
        // Here is the body of the first page
        doSomethingUseful(goodBody, resultCookies);
    });
}
</pre> 
<br> The error path in the code isn't very well modeled, so there's work left to do. So there were just 
<a href="https://www.youtube.com/watch?v=rP0vn9PZ3kU" title="That pun is only for old German bags">7 bridges to cross</a>. 
<br> As usual YMMV.</div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 30 January 2017
<span class="divider">|</span>
<a href="/blog/2017/01/saml-and-the-command-line.html#comments">Comments (1)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/javascript.html">JavaScript</a>  <a href="/blog/categories/nodejs.html">NodeJS</a> 

						<div class="shariff" data-lang="en" data-url="https://www.wissel.net/blog/2017/01/saml-and-the-command-line.html" data-services="[&quot;whatsapp&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;mail&quot;]" data-title="SAML and the Command Line" data-twitter-via="@notessensei"></div>
						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2017/01/saml-and-the-command-line.html";
						</script>
					</p>

				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_134DE77E2F5D7C55482580B8004B2B1E" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_134DE77E2F5D7C55482580B8004B2B1E"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li>
							posted by <b>Mikkel Heisterberg</b> on <i>Tuesday 31 January 2017 AD</i>:<br /> 
  <p>Great code example. </p> 
  <p>No basic auth or OAuth?! If only IBM would get around to using the great API gateways they develop and sell for their own services that code would be done in 5-10 lines... What a shame. </p>
 
							<hr style="clear : both" />
						</li> 					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2017/01/git-deploy-your-static-sites-part-1.html"><i class="icon-hand-left"></i>GIT deploy your static sites - Part 1</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2017/02/agile-outsourcing.html">Agile Outsourcing<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2017/">2017</a> <span class="divider">/</span></li>
  <li><a href="/blog/2017/01/">January</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/javascript.html">JavaScript</a>
  </li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/nodejs.html">NodeJS</a>
  </li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I'm a Cloud "Program Architect Director", working for Salesforce. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a href="https://www.twitter.com/notessensei">Twitter</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://www.xing.com/profile/StephanH_Wissel">XING</a></li>
						<li><a href="https://astore.amazon.com/wissenetblog-20">Amazon Store</a></li>
						<li><a href="https://kindle.amazon.com/profile/Stephan-H--Wissel/1659300">Amazon Kindle</a></li>
						<li><a href="http://notessensei.spreadshirt.com/">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="http://about.me/stephan.wissel/#" title="Another identity site, nothing much here">About Me</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2019 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2017/01/saml-and-the-command-line.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="/blog/js/shariff.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/shCore.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushJava.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushJScript.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushXml.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushBash.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushPlain.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushVb.js"></script>
    <script type="text/javascript" src="/blog/js2/shBrushCss.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>
    <script type="text/javascript">
    $(document).ready(function() {
            SyntaxHighlighter.all();
    });
    </script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "134DE77E2F5D7C55482580B8004B2B1E");
 		};
	</script>

</body>
</html>
