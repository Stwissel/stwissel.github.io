<!DOCTYPE html>
<html lang="en">
<head>
<title>XPages XML Document DataSource - Take 2 - NotesSensei's Blog</title>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-72033-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible"  content="chrome=1" />
<meta http-equiv="Content-Language" content="en" />
<meta rel="meta" link="application/rdf+xml" content="/foaf.rdf" />
<meta property="og:title"     content="wissel.net - XPages XML Document DataSource - Take 2" />
<meta property="og:type"      content="blog" />
<meta property="og:url"       content="https://wissel.net/blog/2015/03/xpages-xml-document-datasource-take-2.html" />
<meta property="og:image"     content="//www.wissel.net/blog/img/wisselnet.gif" />
<meta property="og:site_name" content="wissel.net" />
<meta name="viewport"         content="width=device-width, initial-scale=1.0" />
<meta name="ROBOTS"           content="FOLLOW, NOIMAGEINDEX" />
<meta name="DC.Title"         content="NotesSensei's Weblog - XPages XML Document DataSource - Take 2" />
<meta name="Author"           content="Stephan H. Wissel" />
<meta name="ICBM"             content="1.2994, 103.8425" />
<meta name="Copyright"        content="2002,2022 Stephan H. Wissel - Creative commons licence" />
<meta name="twitter:site"     content="@notessensei" />
<meta name="twitter:card"     content="summary" />
<meta name="xing:author"      content="https://www.xing.com/profile/StephanH_Wissel" />
<meta name="description"
	content="XPages XML Document DataSource - Take 2 - For a recent project I revisited the idea of storing XML documents as MIME entries in Notes - while preserving some of the fields for use in views and the Notes client. Jesse suggested I should have a look at annotations. Turns out, it is easier that it sound. To create an annotation that works at r" />
<meta name="Keywords"
	content="XPages," />
<meta name="Abstract"
	content="XPages XML Document DataSource - Take 2 - For a recent project I revisited the idea of storing XML documents as MIME entries in Notes - while preserving some of the fields for use in views and the Notes client. Jesse suggested I should have a look at annotations. Turns out, it is easier that it sound. To create an annotation that works at r" />
<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/blog/style/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/responsive.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/wisselblog.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/main.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/blogcodedisplay.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/shariff.complete.css" />
<link rel="stylesheet" type="text/css" href="/blog/style/markdown.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/prism.css" />
<link rel="stylesheet" type="text/css" href="/blog/css/admonition.css" />
<link rel="icon" type="image/png" href="/blog/img/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/blog/img/favicon-16x16.png" sizes="16x16" />


<link rel="alternate" type="application/rss+xml" title="RSS News Feed" href="https://feeds.feedburner.com/Wisselnetfeed" />

<meta name="Revisit-After" content="90 Days" />
</head>
<body class="line-numbers">
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<a class="btn btn-navbar" data-toggle="collapse"
				data-target=".nav-collapse"> <span class="icon-bar"></span> <span
				class="icon-bar"></span> <span class="icon-bar"></span>
			</a> <a class="brand" href="/">wissel.net</a>
			<div class="nav-collapse">
				<ul class="nav">
					<li><a href="/index.html">Home</a></li>
					<li class="active"><a href="/blog/">Blog</a></li>
					<li><a href="/blog/series.html">Series</a></li>
					<li><a href="/blog/downloads/">Downloads</a></li>
					<li><a href="https://stwissel.github.io/presentations/" title="Presentations maintained on GitHub">Presentations</a></li>
					<li><a href="/blog/imprint.html">About / Imprint</a></li>
				</ul>
				<form action="//www.google.com/cse" id="cse-search-box"
					class="navbar-search pull-right">
					<div>
						<input type="hidden" name="cx"
							value="partner-pub-4562257798204150:muo14ionenw" /> <input
							type="hidden" name="ie" value="ISO-8859-1" /> <input type="text"
							name="q" class="search-query span2" placeholder="Search" />
						<!-- input type="submit" name="sa" value="Search" class="btn btn-small"/-->
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="navbar-spacer"></div>

	<div class="container">
    		<br />
		<header>
			<div id="mainsmall"  class="hero-unit">
				<h2>wissel.net</h2>
				<p>Usability - Productivity - Business - The web - Singapore &amp; Twins</p>
			</div>
		</header>

     
    <ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2015/">2015</a> <span class="divider">/</span></li>
  <li><a href="/blog/2015/03/">March</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/xpages.html">XPages</a>
  </li>
	<li class="pull-right">
	<span class="divider">|</span><a href="/blog/d6plinks/SHWL-9UBCFS" title="originally published at /blog/d6plinks/SHWL-9UBCFS">SHWL-9UBCFS</a>
	</li>
</ul>

		<div class="row-fluid">
			<div class="span12">
				
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2015/03/develop-local-deploy-cloud-global-java-and-couchdb.html"><i class="icon-hand-left"></i>Develop local, deploy (cloud) global - Java and CouchDB</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2015/04/email-dashboard-for-the-rest-of-us-part-1.html">email Dashboard for the rest of us - Part 1<i class="icon-hand-right"></i></a>
					</li>
				</ul>

				<article class="well well-raised">
					<h1><small>XPages XML Document DataSource - Take 2</small></h1>
					<hr />
					<div>For a recent project I revisited the idea of <a href="blog/2014/09/rethinking-the-mimedocument-data-source.html">storing XML documents</a> as MIME entries in Notes - while preserving some of the fields for use in views and the Notes client. <a href="https://twitter.com/gidgerby">Jesse</a> suggested I should have a look at <a href="http://www.javacodegeeks.com/2014/11/java-annotations-tutorial.html">annotations</a>. Turns out, it is easier that it sound. To create an annotation that works at runtime, I need a one liner only: 
<br><code>@Retention(RetentionPolicy.RUNTIME) public @interface ItemPathMappings { String[] value(); }</code>
<br>
 To further improve usefulness, I created a "BaseConfiguration" my classes will inherit from, that contains the common properties I want all my classes (and documents) to have. You might want to adjust it to your needs: 
<br>
<pre><code class="language-java">
ackage com.notessensei.domino;
import java.io.Serializable;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
/**
 * Common methods implemented by all classes to be Dominoserialized
 */
@XmlRootElement(name = "BaseConfiguration")
@XmlAccessorType(XmlAccessType.NONE)
public abstract class BaseConfiguration implements Serializable, Comparable&lt;BaseConfiguration&gt; {
    private static final long serialVersionUID = 1L;
    @XmlAttribute(name = "name")
    protected String          name;

    public int compareTo(BaseConfiguration bc) {
        return this.toString().compareTo(bc.toString());
    }
    public String getName() {
        return this.name;
    }
    public BaseConfiguration setName(String name) {
        this.name = name;
        return this;
    }
    @Override
    public String toString() {
        return Serializer.toJSONString(this);
    }
    public String toXml() {
        return Serializer.toXMLString(this);
    }
}
</code></pre>
<br>
 The next building block is my Serializer support with a couple of static methods, that make dealing with XML and JSON easier. 
<pre><code class="language-java">
package com.notessensei.domino;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

/**
 * Helper class to serialize / deserialize from/to JSON and XML
 */
public class Serializer {

    public static String toJSONString(Object o) {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        try {
            Serializer.saveJSON(o, out);
        } catch (IOException e) {
            return e.getMessage();
        }
        return out.toString();
    }

    public static String toXMLString(Object o) {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        try {
            Serializer.saveXML(o, out);
        } catch (Exception e) {
            return e.getMessage();
        }
        return out.toString();
    }

    public static void saveJSON(Object o, OutputStream out) throws IOException {
        GsonBuilder gb = new GsonBuilder();
        gb.setPrettyPrinting();
        gb.disableHtmlEscaping();
        Gson gson = gb.create();
        PrintWriter writer = new PrintWriter(out);
        gson.toJson(o, writer);
        writer.flush();
        writer.close();
    }

    public static void saveXML(Object o, OutputStream out) throws Exception {
        JAXBContext context = JAXBContext.newInstance(o.getClass());
        Marshaller m = context.createMarshaller();
        m.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
        m.marshal(o, out);
    }

    public static org.w3c.dom.Document getDocument(Object source) throws ParserConfigurationException, JAXBException {
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        DocumentBuilder db = dbf.newDocumentBuilder();
        org.w3c.dom.Document doc = db.newDocument();
        JAXBContext context = JAXBContext.newInstance(source.getClass());
        Marshaller m = context.createMarshaller();
        m.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
        m.marshal(source, doc);
        return doc;
    }

    @SuppressWarnings("rawtypes")
    public static Object fromByte(byte[] source, Class targetClass) throws JAXBException {
        ByteArrayInputStream in = new ByteArrayInputStream(source);
        JAXBContext context = JAXBContext.newInstance(targetClass);
        Unmarshaller um = context.createUnmarshaller();
        return targetClass.cast(um.unmarshal(in));
    }
}
</code></pre>
<br>
 The key piece is for the XML serialization/deserialization to work is the abstract class <code>AbstractXmlDocument</code>. That class contains the load and save methods that interact with Domino's MIME capabilities as well as executing the XPath expressions to store the Notes fields. The implementations of this abstract class will have annotations that combine the Notes field name, the type and the XPath expression. An implementation would look like this: 
<br>
<pre><code class="language-java">
package com.notessensei.domino.xmldocument;
import javax.xml.bind.JAXBException;
import lotus.domino.Database;
import lotus.domino.Document;
import lotus.domino.NotesException;
import lotus.domino.Session;
import com.notessensei.domino.ApplicationConfiguration;
import com.notessensei.domino.Serializer;
import com.notessensei.domino.xmldocument.AbstractXmlDocument.ItemPathMappings;

// The ItemPathMappings are application specific!
@ItemPathMappings({ "Subject|Text|/Application/@name",
     "Description|Text|/Application/description",
     "Unid|Text|/Application/@unid",
     "Audience|Text|/Application/Audiences/Audience",
     "NumberOfViews|Number|count(/Application/Views/View)",
     "NumberOfForms|Number|count(/Application/Forms/Form)",
     "NumberOfColumns|Number|count(/Application/Views/View/columns/column)",
     "NumberOfFields|Number|count(/Application/Forms/Form/fields/field)",
     "NumberOfActions|Number|count(//action)" })
public class ApplicationXmlDocument extends AbstractXmlDocument {

    public ApplicationXmlDocument(String formName) {
        super(formName);
    }

    @SuppressWarnings("unchecked")
    @Override
    public ApplicationConfiguration load(Session session, Document d) {

        ApplicationConfiguration result = null;
        try {
            result = (ApplicationConfiguration) Serializer.fromByte(this.loadFromMime(session, d), ApplicationConfiguration.class);
        } catch (JAXBException e) {
            e.printStackTrace();
        }
        try {
            result.setUnid(d.getUniversalID());
        } catch (NotesException e) {
            // No Action Taken
        }
        return result;
    }

    @SuppressWarnings("unchecked")
    @Override
    public ApplicationConfiguration load(Session session, Database db, String unid) {
        Document doc;
        try {
            doc = db.getDocumentByUNID(unid);
            if (doc != null) {
                ApplicationConfiguration result = this.load(session, doc);
                doc.recycle();
                return result;
            }

        } catch (NotesException e) {
            e.printStackTrace();
        }

        return null;
    }
}
</code></pre> ## 
<br>
 Here is the base class: 
<br>
<pre><code class="language-java">
package com.notessensei.domino.xmldocument;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.util.Collection;
import java.util.HashSet;
import java.util.Map;
import java.util.Scanner;
import java.util.TreeMap;

import javax.xml.bind.JAXBException;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import lotus.domino.Item;
import lotus.domino.MIMEEntity;
import lotus.domino.MIMEHeader;
import lotus.domino.NotesException;
import lotus.domino.Stream;

import org.w3c.dom.Document;
import org.xml.sax.InputSource;

import com.notessensei.domino.BaseConfiguration;
import com.notessensei.domino.Serializer;

@XmlAccessorType(XmlAccessType.NONE)
public abstract class AbstractXmlDocument {

    /**
     * Holds the the definition that extracts data from an XML Document into
     * a Notes Item. Will be triggered by an annotation in the implementation class
     */
    public class FieldExtractDefinition implements Comparable&lt;FieldExtractDefinition&gt; {

        public final static String ELEMENT_SEPARATOR = "\\|";
        private final String       path;
        private final String       itemName;
        private final FieldType    fieldType;

        /**
         * Creates a FieldExtractDefinition from a raw String in the format:
         * Itemname|FieldType|XPath
         *
         * @param rawString
         */
        public FieldExtractDefinition(String rawString) {
            Scanner scanner = new Scanner(rawString);
            scanner.useDelimiter(ELEMENT_SEPARATOR);
            this.itemName = scanner.next();
            this.fieldType = FieldType.valueOf(scanner.next().toUpperCase());
            // The rest of the elements make the XPath
            this.path = scanner.nextLine().substring(1);
        }

        public int compareTo(FieldExtractDefinition fed) {
            return this.toString().compareTo(fed.toString());
        }

        public FieldType getDataType() {
            return fieldType;
        }

        public String getItemName() {
            return itemName;
        }

        public String getXPath() {
            return path;
        }

        @Override
        public String toString() {
            return Serializer.toJSONString(this);
        }

    }

    public enum FieldType {
        NUMBER, TEXT, NAMES, READER, AUTHOR, DATE
    }

    @Retention(RetentionPolicy.RUNTIME)
    public @interface ItemPathMappings {

        String[] value();

    }

    private final String                             MIME_FIELD_NAME = "Body";
    private final String                             FORM_NAME       = "Form";

    private final Collection&lt;FieldExtractDefinition&gt; definitions     = new HashSet&lt;FieldExtractDefinition&gt;();

    private String                                   formName;

    private org.w3c.dom.Document                     style           = null;

    public AbstractXmlDocument(String formName) {
        this.formName = formName;
        // Now load the annotations
        ItemPathMappings ipm = this.getClass().getAnnotation(ItemPathMappings.class);
        if (ipm != null) {
            for (String oneMapping : ipm.value()) {
                this.definitions.add(new FieldExtractDefinition(oneMapping));
            }
        }
    }

    public String getFormName() {
        return this.formName;
    }

    public org.w3c.dom.Document getStyle() {
        return this.style;
    }

    public abstract &lt;T extends BaseConfiguration&gt; T load(lotus.domino.Session session, lotus.domino.Database db, String unid);

    public abstract &lt;T extends BaseConfiguration&gt; T load(lotus.domino.Session session, lotus.domino.Document d);

    public boolean save(lotus.domino.Session session, lotus.domino.Document d, Object source) {
        boolean success = true;
        try {
            boolean oldMime = session.isConvertMime();
            session.setConvertMime(false);

            // Save the form to be sure
            if (this.formName != null) {
                d.replaceItemValue(FORM_NAME, this.formName);
            }

            // We must remove the mime body - otherwise it will not work
            if (d.hasItem(MIME_FIELD_NAME)) {
                d.removeItem(MIME_FIELD_NAME);
            }

            org.w3c.dom.Document domDoc = Serializer.getDocument(source);

            // Create the top mime entry
            MIMEEntity root = d.createMIMEEntity(MIME_FIELD_NAME);
            MIMEHeader header = root.createHeader("Content-Type");
            header.setHeaderVal("multipart/mixed");

            MIMEEntity body = root.createChildEntity();
            MIMEHeader bheader = body.createHeader("Content-Type");
            bheader.setHeaderVal("multipart/alternative");

            MIMEEntity textMime = body.createChildEntity();
            MIMEHeader textHeader = textMime.createHeader("Content-Type");
            String cType = (this.style == null) ? "text/plain" : "text/html";
            textHeader.setHeaderVal(cType);

            Stream stream2 = session.createStream();
            stream2.write(this.dom2Byte(domDoc, this.style));
            textMime.setContentFromBytes(stream2, cType + "; charset=\"UTF-8\"", MIMEEntity.ENC_NONE);

            MIMEEntity xmlMime = body.createChildEntity();
            MIMEHeader xmlHeader = xmlMime.createHeader("Content-Type");
            xmlHeader.setHeaderVal("application/xml");

            Stream stream = session.createStream();
            stream.write(this.dom2Byte(domDoc, null));
            xmlMime.setContentFromBytes(stream, "application/xml; charset=\"UTF-8\"", MIMEEntity.ENC_NONE);

            // Now extract the fields
            this.extractFields(domDoc, d, body);

            session.setConvertMime(oldMime);
        } catch (NotesException e) {
            success = false;
            e.printStackTrace();
        } catch (ParserConfigurationException e) {
            success = false;
            e.printStackTrace();
        } catch (JAXBException e) {
            success = false;
            e.printStackTrace();
        }

        return success;
    }

    public Map&lt;String, String&gt; extractMappingResults(Object source) throws ParserConfigurationException, JAXBException {
        Map&lt;String, String&gt; result = new TreeMap&lt;String, String&gt;();
        org.w3c.dom.Document domDoc = (source instanceof org.w3c.dom.Document) ? (org.w3c.dom.Document) source : Serializer
                    .getDocument(source);
        for (FieldExtractDefinition f : this.definitions) {
            String candidate = this.extractOneField(domDoc, f.getXPath());
            if (candidate != null) {
                result.put(f.getItemName(), candidate);
            }
        }

        return result;
    }

    public void setFormName(String formName) {
        this.formName = formName;
    }

    public AbstractXmlDocument setPrettyPrintStyle(org.w3c.dom.Document style) {
        this.style = style;
        return this;
    }

    public void setStyle(InputStream styleStream) {

        Document d = null;
        final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setValidating(false); // Will blow if set to true
        factory.setNamespaceAware(true);

        try {
            InputSource source = new InputSource(styleStream);
            final DocumentBuilder docb = factory.newDocumentBuilder();
            d = docb.parse(source);

        } catch (final Exception e) {
            e.printStackTrace();
            d = null;
        }

        if (d == null) {
            System.out.println("DOM from stream generation failed:\n");
        }

        this.style = d;
    }

    /**
     * Loads XML from Notes document and returns the content as bytes to
     * be marshalled into a Java object creation
     *
     * @param session
     *            NotesSession
     * @param d
     *            Document with MIME content
     * @return bytes for object instance creation
     */
    protected byte[] loadFromMime(lotus.domino.Session session, lotus.domino.Document d) {
        ByteArrayOutputStream out = new ByteArrayOutputStream();

        try {
            boolean oldMime = session.isConvertMime();
            session.setConvertMime(false);

            // Load the TOP mime entitiy - must be multipart/mixed
            MIMEEntity root = d.getMIMEEntity(MIME_FIELD_NAME);
            if (root != null &amp;&amp; root.getContentType().equals("multipart") &amp;&amp; root.getContentSubType().equals("mixed")) {
                // We check for the body whtou should be multipart/alternate
                MIMEEntity body = root.getFirstChildEntity();
                if (body != null &amp;&amp; body.getContentType().equals("multipart") &amp;&amp; body.getContentSubType().equals("alternative")) {
                    // Now we go after Content-Type = application/xml
                    MIMEEntity payload = body.getFirstChildEntity();

                    while (payload != null &amp;&amp; !payload.getContentSubType().equals("xml")) {
                        System.out.println(payload.getContentType());
                        System.out.println(payload.getContentSubType());
                        MIMEEntity nextMime = payload.getNextEntity();
                        payload.recycle();
                        payload = nextMime;
                    }

                    if (payload != null) {
                        Stream notesStream = session.createStream();
                        payload.getContentAsBytes(notesStream);
                        notesStream.setPosition(0);
                        notesStream.getContents(out);
                        notesStream.recycle();
                    }
                }

            }
            ;
            session.setConvertMime(oldMime);
        } catch (NotesException e) {
            e.printStackTrace();
        }

        return out.toByteArray();
    }

    private byte[] dom2Byte(Document dom, Document stylesheet) {
        StreamResult xResult = null;
        DOMSource source = null;
        final ByteArrayOutputStream out = new ByteArrayOutputStream();
        Transformer transformer = null;

        try {
            final TransformerFactory tFactory = TransformerFactory.newInstance();
            xResult = new StreamResult(out);
            source = new DOMSource(dom);

            if (stylesheet != null) {
                final DOMSource style = new DOMSource(stylesheet);
                transformer = tFactory.newTransformer(style);
            } else {
                transformer = tFactory.newTransformer();
            }

            // We don't want the XML declaration in front
            transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");

            transformer.transform(source, xResult);

        } catch (final Exception e) {
            e.printStackTrace();
        }

        return out.toByteArray();

    }

    private void extractFields(Document domDoc, lotus.domino.Document d, MIMEEntity body) {
        Map&lt;String, String&gt; itemList = null;
        try {
            itemList = this.extractMappingResults(domDoc);
        } catch (ParserConfigurationException e1) {
            e1.printStackTrace();
        } catch (JAXBException e1) {
            e1.printStackTrace();
        }

        if (itemList == null) {
            return;
        }

        for (FieldExtractDefinition f : this.definitions) {

            String fName = f.getItemName();
            String fValue = itemList.get(fName);

            if (!fName.equalsIgnoreCase(MIME_FIELD_NAME) &amp;&amp; !(fValue == null)) {
                // We can't allow to overwrite the body or write empty values
                try {
                    MIMEHeader h = body.createHeader(fName);
                    h.setHeaderVal(fValue);
                    Item curItem = d.replaceItemValue(fName, fValue);
                    FieldType ft = f.getDataType();
                    if (ft.equals(FieldType.AUTHOR)) {
                        curItem.setAuthors(true);
                    } else if (ft.equals(FieldType.READER)) {
                        curItem.setReaders(true);
                    }

                } catch (NotesException e) {
                    e.printStackTrace();
                }
            }

        }
    }

    private String extractOneField(Document domDoc, String xPathString) {

        Object exprResult = null;
        final XPath xpath = XPathFactory.newInstance().newXPath();
        final MagicNamespaceContext nsc = new MagicNamespaceContext();
        xpath.setNamespaceContext(nsc);

        try {
            exprResult = xpath.evaluate(xPathString, domDoc);
        } catch (final XPathExpressionException e) {
            System.err.println("XPATH failed for " + xPathString);
            System.err.println(e.getMessage());
        }
        // if it failed we abort
        if (exprResult == null) {
            return null;
        }

        return exprResult.toString();

    }
}
</code></pre>
<br>
 As time permits I will provide a full working example. 
<br>
 YMMV!</div>
					<hr />
					<p>
						Posted by <a rel="author" href="https://plus.google.com/u/0/+StephanWissel">
Stephan H Wissel</a> on 05 March 2015
<span class="divider">|</span>
<a href="/blog/2015/03/xpages-xml-document-datasource-take-2.html#comments">Comments (0)</a>
<span class="divider">|</span>
categories:  <a href="/blog/categories/xpages.html">XPages</a> 

						<script type="text/javascript">
							var permaLink = "https://wissel.net/blog/2015/03/xpages-xml-document-datasource-take-2.html";
						</script>
					</p>
				</article>
				<a name="comments"></a>
				<div class="well well-raised" style="text-align : center">
				<button class="btn btn-lg btn-info" data-toggle="collapse" data-target="#commentform_3CDF90B93B366B9448257DFF0030E378" type="button">
		            Add your comment...&nbsp;&nbsp;<span class="glyphicon glyphicon-comment"></span>
	            </button>
	            </div>
				<div id="commentform_3CDF90B93B366B9448257DFF0030E378"  class="collapse"></div>
				<div class="well well-raised">
					<h4>Comments</h4>
					<ol id="commentList">
						<li id="nocomments">
							<h5>No comments yet, be the first to comment</h5>
						</li>
					</ol>
				</div>
				<ul class="breadcrumb pull-centre">
					<li><a href="/blog/2015/03/develop-local-deploy-cloud-global-java-and-couchdb.html"><i class="icon-hand-left"></i>Develop local, deploy (cloud) global - Java and CouchDB</a>
						<span class="divider">|</span></li>
					<li><a href="/blog/"><i class="icon-hand-up"></i>Main</a></li>
					<span class="divider">|</span>
					<li><a href="/blog/2015/04/email-dashboard-for-the-rest-of-us-part-1.html">email Dashboard for the rest of us - Part 1<i class="icon-hand-right"></i></a>
					</li>
				</ul>

			</div>
		</div>
		<ul class="breadcrumb">
  <li><a href="/blog/">Blog</a> <span class="divider">/</span></li>
  <li><a href="/blog/2015/">2015</a> <span class="divider">/</span></li>
  <li><a href="/blog/2015/03/">March</a></li>
  <li class="pull-right">
    <span class="divider">|</span><a href="/blog/categories/xpages.html">XPages</a>
  </li>
	<li class="pull-right">
	<span class="divider">|</span><a href="/blog/d6plinks/SHWL-9UBCFS" title="originally published at /blog/d6plinks/SHWL-9UBCFS">SHWL-9UBCFS</a>
	</li>
</ul>

	</div>
	<footer>
		<div class="container">
			<div class="row">
				<div class="span2">
					<h4>About Me</h4>
					<p>
						I work as "Solution Director Innovation" for HCL Software. I'm based in Singapore.
						<g:plusone size="small" href="https://wissel.net/blog/"></g:plusone>
					</p>
					<a href="//stackoverflow.com/users/131021/stwissel">
					<img src="//stackoverflow.com/users/flair/131021.png" width="208" height="58" alt="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer" title="profile for stwissel at Stack Overflow, Q&amp;A for professional and enthusiast programmer">
				</a>
				</div>
				<div class="span2">
					<h4>Contact</h4>
					<ul>
						<li><a rel="me" href="https://chaos.social/@stw">Chat on Mastodon</a></li>
						<li><a href="https://sg.linkedin.com/in/notessensei">LinkedIn</a></li>
						<li><a href="https://notessensei.myspreadshop.com">NotesSensei's Spreadshirt shop</a></li>
						<li><a href="https://www.stickermule.com/u/43c09fe6343315f">Stickers from Stickermule</a></li>
						<li><a href="https://github.com/Stwissel">GitHub</a></li>
						<li><a href="https://bitbucket.org/stwissel/">Bitbucket</a></li>
						<li><a href="https://bsky.app/profile/stwissel.bsky.social">Bluesky</a></li>
					</ul>
				</div>
				<div class="span8">
					<h4>Disclaimer</h4>
					<p>This site is in no way affiliated, endorsed, sanctioned,
						supported, nor enlightened by my current or previous employers.
						I may be an employee, but the opinions, theories, facts, etc.
						presented here are my own and are in now way given in any official
						capacity. In short, these are my words and this is my site, not
						my current or former employers' - and don't even begin to think otherwise.</p>
					<p>
						<b>&copy; 2003 - 2025 Stephan H. Wissel - some rights reserved</b> as
						listed here: <a rel="license"
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"><img
							alt="Creative Commons License" style="border-width: 0"
							src="//licensebuttons.net/l/by-nc-sa/3.0/88x31.png" /></a>
						Unless otherwise labeled by its originating author, the content
						found on this site is made available under the terms of an <a
							href="//creativecommons.org/licenses/by-nc-sa/3.0/"
							target="_blank"
							title="Learn more about the creative commons  Attribution-ShareAlike License">Attribution/NonCommercial/ShareAlike
							Creative Commons License</a>, with the exception that no rights are
						granted -- since they are not mine to grant -- in any logo,
						graphic design, trademarks or trade names of any type. Code
						samples and code downloads on this site are, unless otherwise
						labeled, made available under an <a
							href="//www.apache.org/licenses/LICENSE-2.0.html">Apache
							2.0</a> license. Other license models are available on written
						request and written confirmation.
					</p>
				</div>
			</div>
		</div>
	</footer>

	<script type="text/javascript">
		var permaLink = "https://wissel.net/blog/2015/03/xpages-xml-document-datasource-take-2.html";
	</script>
		<script type="text/javascript" src="/blog/js/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="/blog/js/bootstrap.js"></script>
	<script type="text/javascript" src="/blog/js/blogmain.js"></script>
    <script type="text/javascript" src="/blog/js2/prism.js"></script>
	<script type="text/javascript" src="/blog/js2/admonition.js"></script>
	<script src="//www.google-analytics.com/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uacct = "UA-72033-1";
		urchinTracker();
	</script>
	<script type="text/javascript" src="//feeds.feedburner.com/~s/Wisselnet?i=https://wissel.net/blog" charset="utf-8"></script>

		<script src="/blog/js2/mustache.js"></script>
	<script src="/blog/js2/blogcomments.js"></script>
	<script type="text/javascript" src="/blog/js2/Markdown.Converter.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Sanitizer.js"></script>
    <script type="text/javascript" src="/blog/js2/Markdown.Editor.js"></script>
	<script type="text/javascript" src="//www.google.com/recaptcha/api.js"></script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
	<script type="text/javascript">
		var onloadCallback = function() {
    		renderComment("6LcBxUEUAAAAACzKM8YKb-RVVaIZ3MN6F1Z8FB_4", "3CDF90B93B366B9448257DFF0030E378");
 		};
	</script>

</body>
</html>
